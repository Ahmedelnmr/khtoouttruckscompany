@model IEnumerable<Khutootcompany.Application.DTOs.InsuranceRenewalDto>

@{
    ViewData["Title"] = "سجل تأمين الشاحنة";
    var truckPlate = ViewBag.TruckPlate as string ?? "";
    var truckModel = ViewBag.TruckModel as string ?? "";
    var truckId = ViewBag.TruckId as int? ?? 0;
    var currentExpiryDate = ViewBag.CurrentExpiryDate as DateTime?;
    var totalCost = Model.Sum(r => r.Cost);
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-shield-alt"></i> سجل تأمين الشاحنة
        </h1>
        <div>
            <a href="/InsuranceRenewals/History" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> رجوع للسجل العام
            </a>
            <a href="/Trucks/Details/@truckId" class="btn btn-info">
                <i class="fas fa-truck"></i> تفاصيل الشاحنة
            </a>
        </div>
    </div>

    <!-- Truck Info Card -->
    <div class="card shadow mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-truck"></i> معلومات الشاحنة
            </h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">رقم اللوحة</h6>
                            <h3 class="text-primary mb-3">@truckPlate</h3>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">الموديل</h6>
                            <h3 class="text-dark mb-3">@truckModel</h3>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">تاريخ انتهاء التأمين الحالي</h6>
                            @if (currentExpiryDate.HasValue)
                            {
                                var daysRemaining = (currentExpiryDate.Value - DateTime.Today).Days;
                                var isExpired = currentExpiryDate.Value < DateTime.Today;
                                
                                <h4 class="@(isExpired ? "text-danger" : daysRemaining <= 30 ? "text-warning" : "text-success")">
                                    @currentExpiryDate.Value.ToString("dd/MM/yyyy")
                                    @if (isExpired)
                                    {
                                        <span class="badge bg-danger">منتهي منذ @Math.Abs(daysRemaining) يوم</span>
                                    }
                                    else if (daysRemaining <= 30)
                                    {
                                        <span class="badge bg-warning text-dark">باقي @daysRemaining يوم</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">صالح</span>
                                    }
                                </h4>
                            }
                            else
                            {
                                <h4 class="text-muted">غير محدد</h4>
                            }
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">عدد مرات التجديد</h6>
                            <h4 class="text-info">@Model.Count() مرة</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <button class="btn btn-success btn-lg w-100 mb-2" 
                            onclick="openRenewModal(@truckId, '@truckPlate')">
                        <i class="fas fa-redo"></i> تجديد التأمين الآن
                    </button>
                    <p class="text-muted small mb-0">
                        إجمالي ما تم دفعه: <strong class="text-success">@totalCost.ToString("N3") د.ك</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow text-center">
                <div class="card-body">
                    <i class="fas fa-sync-alt fa-2x text-primary mb-2"></i>
                    <h6 class="text-muted small">عدد التجديدات</h6>
                    <h3 class="text-primary mb-0">@Model.Count()</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow text-center">
                <div class="card-body">
                    <i class="fas fa-money-bill-wave fa-2x text-success mb-2"></i>
                    <h6 class="text-muted small">إجمالي التكلفة</h6>
                    <h3 class="text-success mb-0">@totalCost.ToString("N0")</h3>
                    <small class="text-muted">د.ك</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow text-center">
                <div class="card-body">
                    <i class="fas fa-calculator fa-2x text-info mb-2"></i>
                    <h6 class="text-muted small">متوسط التكلفة</h6>
                    <h3 class="text-info mb-0">
                        @if (Model.Any())
                        {
                            @((totalCost / Model.Count()).ToString("N0"))
                        }
                        else
                        {
                            @:0
                        }
                    </h3>
                    <small class="text-muted">د.ك</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-alt fa-2x text-warning mb-2"></i>
                    <h6 class="text-muted small">آخر تجديد</h6>
                    <h3 class="text-warning mb-0">
                        @if (Model.Any())
                        {
                            @Model.First().RenewalDate.ToString("MM/yyyy")
                        }
                        else
                        {
                            @:-
                        }
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Renewals History Table -->
    <div class="card shadow">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-history"></i> سجل التجديدات التفصيلي
            </h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>تاريخ التجديد</th>
                                <th>تاريخ الانتهاء</th>
                                <th>المدة</th>
                                <th>الحالة</th>
                                <th>التكلفة</th>
                                <th>رقم السند</th>
                                <th>الملاحظات</th>
                                <th>المستخدم</th>
                                <th>التاريخ المسجل</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int index = 1;
                            }
                            @foreach (var renewal in Model)
                            {
                                var duration = (renewal.ExpiryDate - renewal.RenewalDate).Days;
                                var isExpired = renewal.ExpiryDate < DateTime.Today;
                                var isCurrent = currentExpiryDate.HasValue && 
                                               renewal.ExpiryDate.Date == currentExpiryDate.Value.Date;
                                var rowClass = isCurrent ? "table-primary" : (isExpired ? "table-secondary" : "");

                                <tr class="@rowClass">
                                    <td>
                                        @index
                                        @if (isCurrent)
                                        {
                                            <span class="badge bg-primary">الحالي</span>
                                        }
                                    </td>
                                    <td>
                                        <i class="fas fa-calendar-check text-success"></i>
                                        @renewal.RenewalDate.ToString("dd/MM/yyyy")
                                    </td>
                                    <td>
                                        <i class="fas fa-calendar-times @(isExpired ? "text-danger" : "text-info")"></i>
                                        @renewal.ExpiryDate.ToString("dd/MM/yyyy")
                                    </td>
                                    <td>
                                        @if (duration >= 365)
                                        {
                                            <span class="badge bg-success">سنة</span>
                                        }
                                        else if (duration >= 180)
                                        {
                                            <span class="badge bg-info">6 أشهر</span>
                                        }
                                        else if (duration >= 30)
                                        {
                                            <span class="badge bg-warning text-dark">@Math.Round(duration / 30.0) شهر</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">@duration يوم</span>
                                        }
                                    </td>
                                    <td>
                                        @if (isCurrent)
                                        {
                                            if (isExpired)
                                            {
                                                <span class="badge bg-danger">منتهي</span>
                                            }
                                            else
                                            {
                                                var daysLeft = (renewal.ExpiryDate - DateTime.Today).Days;
                                                if (daysLeft <= 30)
                                                {
                                                    <span class="badge bg-warning text-dark">ينتهي قريباً (@daysLeft يوم)</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">ساري</span>
                                                }
                                            }
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">منتهي</span>
                                        }
                                    </td>
                                    <td>
                                        <strong class="text-success">@renewal.Cost.ToString("N3") د.ك</strong>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(renewal.SondNumber))
                                        {
                                            <code>@renewal.SondNumber</code>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(renewal.Notes))
                                        {
                                            <small class="text-muted">@renewal.Notes</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <small>
                                            <i class="fas fa-user text-primary"></i>
                                            @renewal.CreatedBy
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            @renewal.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </td>
                                </tr>
                                index++;
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="5" class="text-end">الإجمالي:</th>
                                <th><strong class="text-success">@totalCost.ToString("N3") د.ك</strong></th>
                                <th colspan="4"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Timeline Visualization (Optional) -->
                <div class="mt-4">
                    <h5 class="mb-3"><i class="fas fa-chart-line"></i> الخط الزمني للتجديدات</h5>
                    <div class="position-relative" style="padding: 20px 0;">
                        @foreach (var renewal in Model.OrderBy(r => r.RenewalDate))
                        {
                            var isCurrent = currentExpiryDate.HasValue && 
                                           renewal.ExpiryDate.Date == currentExpiryDate.Value.Date;
                            
                            <div class="mb-3 d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-@(isCurrent ? "primary" : "secondary") text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3 border-start border-3 ps-3 pb-3">
                                    <h6 class="mb-1">
                                        @renewal.RenewalDate.ToString("dd/MM/yyyy")
                                        @if (isCurrent)
                                        {
                                            <span class="badge bg-primary">الحالي</span>
                                        }
                                    </h6>
                                    <p class="mb-1 text-muted">
                                        صالح حتى: <strong>@renewal.ExpiryDate.ToString("dd/MM/yyyy")</strong>
                                    </p>
                                    <p class="mb-0">
                                        <span class="badge bg-success">@renewal.Cost.ToString("N3") د.ك</span>
                                        @if (!string.IsNullOrEmpty(renewal.SondNumber))
                                        {
                                            <code class="ms-2">@renewal.SondNumber</code>
                                        }
                                    </p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center py-5">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <h5>لا يوجد سجل تجديد لهذه الشاحنة</h5>
                    <p class="text-muted">قم بتجديد التأمين لبدء السجل</p>
                    <button class="btn btn-success mt-3" onclick="openRenewModal(@truckId, '@truckPlate')">
                        <i class="fas fa-plus"></i> تجديد التأمين الآن
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Renew Modal (Using the same modal from Index page) -->
<div class="modal fade" id="renewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-redo"></i> تجديد التأمين
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/InsuranceRenewals/Renew" id="renewForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" id="truckId" name="truckId" value="@truckId" />
                    
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-2"><i class="fas fa-truck"></i> الشاحنة:</h6>
                        <p class="mb-0 h5" id="truckInfo">@truckPlate - @truckModel</p>
                    </div>

                    <div class="mb-3">
                        <label for="expiryDate" class="form-label">
                            <i class="fas fa-calendar-times"></i> تاريخ انتهاء التأمين الجديد *
                        </label>
                        <input type="date" class="form-control form-control-lg" id="expiryDate" name="expiryDate" required />
                        <small class="text-muted" id="durationText"></small>
                    </div>

                    <div class="mb-3">
                        <label for="cost" class="form-label">
                            <i class="fas fa-money-bill-wave"></i> تكلفة التأمين (د.ك) *
                        </label>
                        <input type="number" step="0.001" class="form-control form-control-lg" 
                               id="cost" name="cost" placeholder="0.000" required />
                    </div>

                    <div class="mb-3">
                        <label for="sondNumber" class="form-label">
                            <i class="fas fa-receipt"></i> رقم السند
                        </label>
                        <input type="text" class="form-control" id="sondNumber" name="sondNumber" />
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">
                            <i class="fas fa-sticky-note"></i> ملاحظات
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-check"></i> تأكيد التجديد
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openRenewModal(truckId, truckPlate) {
            $('#truckId').val(truckId);
            
            // Set default expiry date (1 year from today)
            const today = new Date();
            const nextYear = new Date(today);
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            $('#expiryDate').val(nextYear.toISOString().split('T')[0]);
            
            updateDuration();
            $('#renewModal').modal('show');
        }

        function updateDuration() {
            const expiryDate = new Date($('#expiryDate').val());
            const today = new Date();
            
            if (expiryDate) {
                const diffTime = Math.abs(expiryDate - today);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffMonths = Math.round(diffDays / 30);
                
                $('#durationText').html(`<i class="fas fa-clock"></i> المدة: ${diffMonths} شهر (${diffDays} يوم)`);
            }
        }

        $(document).ready(function() {
            $('#expiryDate').on('change', updateDuration);

            $('#renewForm').on('submit', function(e) {
                const cost = parseFloat($('#cost').val());
                if (!cost || cost <= 0) {
                    e.preventDefault();
                    alert('يجب إدخال تكلفة التأمين');
                    return false;
                }

                if (!confirm('هل أنت متأكد من تجديد التأمين؟')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}