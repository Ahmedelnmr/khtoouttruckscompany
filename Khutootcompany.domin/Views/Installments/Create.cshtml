@model Khutootcompany.Application.DTOs.InstallmentDto

@{
    ViewData["Title"] = "إضافة قسط جديد";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-credit-card"></i> إضافة قسط جديد
        </h1>
        <a href="/Installments" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i> رجوع للقائمة
        </a>
    </div>

    <form method="post" asp-action="Create" id="installmentForm">
        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

        <div class="row">
            <!-- Right Section -->
            <div class="col-md-6">
                <!-- Basic Info Card -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> البيانات الأساسية</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-truck"></i> الشاحنة *
                            </label>
                            <select asp-for="TruckId" class="form-select" required>
                                <option value="">-- اختر الشاحنة --</option>
                                @foreach (var truck in ViewBag.Trucks)
                                {
                                    <option value="@truck.Value">@truck.Text</option>
                                }
                            </select>
                            <span asp-validation-for="TruckId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-user"></i> السائق (المشتري) *
                            </label>
                            <select asp-for="EmployeeId" class="form-select" required>
                                <option value="">-- اختر السائق --</option>
                                @foreach (var emp in ViewBag.Employees)
                                {
                                    <option value="@emp.Value">@emp.Text</option>
                                }
                            </select>
                            <span asp-validation-for="EmployeeId" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt"></i> تاريخ البداية *
                                </label>
                                <input asp-for="StartDate" type="date" class="form-control" required />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-clock"></i> عدد الأشهر *
                                </label>
                                <input asp-for="TotalMonths" type="number" class="form-control" min="1" max="120" value="36" required />
                                <span asp-validation-for="TotalMonths" class="text-danger"></span>
                                <small class="text-muted">افتراضياً: 36 شهر (3 سنوات)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Info Card -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> المعلومات المالية</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-dollar-sign"></i> سعر المكتب (الأعلى) *
                            </label>
                            <input asp-for="TotalPriceOffice" type="number" step="0.001" class="form-control" 
                                   id="priceOffice" required onchange="calculateProfit()" />
                            <span asp-validation-for="TotalPriceOffice" class="text-danger"></span>
                            <small class="text-muted">السعر الذي سيدفعه السائق للمكتب</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-dollar-sign"></i> سعر الساير (الأقل) *
                            </label>
                            <input asp-for="TotalPriceSayer" type="number" step="0.001" class="form-control" 
                                   id="priceSayer" required onchange="calculateProfit()" />
                            <span asp-validation-for="TotalPriceSayer" class="text-danger"></span>
                            <small class="text-muted">السعر الأصلي من الساير</small>
                        </div>

                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                <i class="fas fa-chart-line"></i> هامش الربح المتوقع:
                            </h6>
                            <h3 class="mb-0 text-success" id="profitMargin">0.000 د.ك</h3>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-check"></i> القسط الشهري *
                            </label>
                            <input asp-for="MonthlyQest" type="number" step="0.001" class="form-control" required />
                            <span asp-validation-for="MonthlyQest" class="text-danger"></span>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="autoCalculateMonthly()">
                                <i class="fas fa-calculator"></i> حساب تلقائي
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Left Section -->
            <div class="col-md-6">
                <!-- Finance Source Card -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-building"></i> مصدر التمويل</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-university"></i> الجهة الممولة
                            </label>
                            <select asp-for="FinanceSource" class="form-select">
                                <option value="">-- اختر المصدر --</option>
                                <option value="الساير">الساير</option>
                                <option value="أنوار السالمي">أنوار السالمي</option>
                                <option value="السلام">السلام</option>
                                <option value="مباشر">مباشر</option>
                                <option value="البنك الأهلي">البنك الأهلي</option>
                                <option value="بنك الكويت الوطني">بنك الكويت الوطني</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                            <span asp-validation-for="FinanceSource" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-receipt"></i> رقم معاملة الساير
                            </label>
                            <input asp-for="SayerTransactionNumber" class="form-control" maxlength="50" 
                                   placeholder="إن وجد" />
                            <span asp-validation-for="SayerTransactionNumber" class="text-danger"></span>
                        </div>

                        <div class="alert alert-light border">
                            <h6><i class="fas fa-info-circle"></i> معلومات مهمة:</h6>
                            <ul class="mb-0 small">
                                <li>تأكد من صحة الأسعار قبل الحفظ</li>
                                <li>سيتم حساب المتبقي تلقائياً</li>
                                <li>يمكن تسجيل الدفعات لاحقاً</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-sticky-note"></i> ملاحظات</h5>
                    </div>
                    <div class="card-body">
                        <textarea asp-for="Notes" class="form-control" rows="5" 
                                  placeholder="أي ملاحظات إضافية عن القسط..."></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="card shadow border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator"></i> ملخص القسط</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>السعر الكلي:</strong></td>
                                <td class="text-end" id="summaryOffice">0.000 د.ك</td>
                            </tr>
                            <tr>
                                <td><strong>عدد الأشهر:</strong></td>
                                <td class="text-end" id="summaryMonths">36 شهر</td>
                            </tr>
                            <tr>
                                <td><strong>القسط الشهري:</strong></td>
                                <td class="text-end" id="summaryMonthly">0.000 د.ك</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>الربح المتوقع:</strong></td>
                                <td class="text-end fw-bold" id="summaryProfit">0.000 د.ك</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i> حفظ القسط
                    </button>
                    <a href="/Installments" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> إلغاء
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        function calculateProfit() {
            var office = parseFloat($('#priceOffice').val()) || 0;
            var sayer = parseFloat($('#priceSayer').val()) || 0;
            var profit = office - sayer;
            
            $('#profitMargin').text(profit.toFixed(3) + ' د.ك');
            $('#summaryOffice').text(office.toFixed(3) + ' د.ك');
            $('#summaryProfit').text(profit.toFixed(3) + ' د.ك');
        }

        function autoCalculateMonthly() {
            var office = parseFloat($('#priceOffice').val()) || 0;
            var months = parseInt($('#TotalMonths').val()) || 36;
            
            if (office > 0 && months > 0) {
                var monthly = office / months;
                $('#MonthlyQest').val(monthly.toFixed(3));
                $('#summaryMonthly').text(monthly.toFixed(3) + ' د.ك');
            } else {
                alert('الرجاء إدخال السعر وعدد الأشهر أولاً');
            }
        }

        $(document).ready(function() {
            // Update summary on change
            $('#priceOffice, #priceSayer').on('change', calculateProfit);
            
            $('#TotalMonths').on('change', function() {
                $('#summaryMonths').text($(this).val() + ' شهر');
            });

            $('#MonthlyQest').on('change', function() {
                $('#summaryMonthly').text(parseFloat($(this).val()).toFixed(3) + ' د.ك');
            });

            // Set default date
            if (!$('#StartDate').val()) {
                var today = new Date().toISOString().split('T')[0];
                $('#StartDate').val(today);
            }
        });
    </script>
}