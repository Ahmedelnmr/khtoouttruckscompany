@model Khutootcompany.Application.DTOs.VisitCardDto

@{
    ViewData["Title"] = "تعديل كارت الزيارة";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-edit"></i> تعديل كارت الزيارة
        </h1>
        <div>
            <a href="/VisitCards" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> رجوع للقائمة
            </a>
            <a href="/VisitCards/Details/@Model.VisitCardId" class="btn btn-info">
                <i class="fas fa-eye"></i> عرض التفاصيل
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-id-card"></i> تحديث بيانات كارت الزيارة
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="Edit" id="editCardForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="VisitCardId" />
                        <input type="hidden" asp-for="EmployeeId" />
                        <input type="hidden" asp-for="TruckId" />
                        <input type="hidden" asp-for="CreatedBy" />
                        <input type="hidden" asp-for="CreatedDate" />

                        <div asp-validation-summary="All" class="alert alert-danger"></div>

                        <!-- Current Card Info (Read-only) -->
                        <div class="card mb-4 bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle"></i> معلومات الكارت الحالية
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>الموظف:</strong> @Model.EmployeeName</p>
                                        <p class="mb-2"><strong>الشاحنة:</strong> @(Model.TruckPlate ?? "غير محددة")</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>تم الإنشاء:</strong> @Model.CreatedDate.ToString("dd/MM/yyyy")</p>
                                        <p class="mb-2"><strong>بواسطة:</strong> @Model.CreatedBy</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Editable Dates -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="IssueDate" class="form-label">
                                    <i class="fas fa-calendar-plus"></i> تاريخ الإصدار <span class="text-danger">*</span>
                                </label>
                                <input asp-for="IssueDate" type="date" class="form-control" id="issueDate" required />
                                <span asp-validation-for="IssueDate" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="ExpiryDate" class="form-label">
                                    <i class="fas fa-calendar-times"></i> تاريخ الانتهاء <span class="text-danger">*</span>
                                </label>
                                <input asp-for="ExpiryDate" type="date" class="form-control" id="expiryDate" required />
                                <span asp-validation-for="ExpiryDate" class="text-danger"></span>
                                <small class="text-muted" id="durationText"></small>
                            </div>
                        </div>

                        <!-- Price and Payment -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="Price" class="form-label">
                                    <i class="fas fa-money-bill-wave"></i> السعر (د.ك)
                                </label>
                                <input asp-for="Price" type="number" step="0.001" class="form-control form-control-lg" readonly style="background-color: #e9ecef; font-weight: bold;" />
                                <small class="text-success">
                                    <i class="fas fa-info-circle"></i> السعر الثابت: 15 د.ك
                                </small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-credit-card"></i> حالة الدفع
                                </label>
                                <div class="form-check form-switch" style="padding-top: 10px;">
                                    <input asp-for="IsPaid" class="form-check-input" type="checkbox" id="isPaidSwitch" style="width: 3rem; height: 1.5rem;">
                                    <label class="form-check-label" for="isPaidSwitch" style="padding-top: 5px; margin-right: 10px;">
                                        <strong id="paidLabel">@(Model.IsPaid ? "مدفوع" : "غير مدفوع")</strong>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Intermediary Info -->
                        <div class="card mb-4 bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-tie"></i> بيانات الوسيط
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="IntermediaryName" class="form-label">
                                            <i class="fas fa-signature"></i> اسم الوسيط
                                        </label>
                                        <input asp-for="IntermediaryName" type="text" class="form-control" placeholder="اسم الوسيط (إن وجد)" maxlength="100" />
                                        <span asp-validation-for="IntermediaryName" class="text-danger"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label asp-for="IntermediaryPhone" class="form-label">
                                            <i class="fas fa-phone"></i> رقم هاتف الوسيط
                                        </label>
                                        <input asp-for="IntermediaryPhone" type="tel" class="form-control" placeholder="+965 12345678" maxlength="20" />
                                        <span asp-validation-for="IntermediaryPhone" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sond Number and Notes -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="SondNumber" class="form-label">
                                    <i class="fas fa-receipt"></i> رقم السند
                                </label>
                                <input asp-for="SondNumber" type="text" class="form-control" placeholder="رقم السند (اختياري)" maxlength="50" />
                                <span asp-validation-for="SondNumber" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Notes" class="form-label">
                                    <i class="fas fa-sticky-note"></i> ملاحظات
                                </label>
                                <input asp-for="Notes" type="text" class="form-control" placeholder="ملاحظات إضافية" maxlength="500" />
                                <span asp-validation-for="Notes" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Status Alert -->
                        @if (Model.IsExpired)
                        {
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>تحذير:</strong> هذا الكارت منتهي الصلاحية منذ @((DateTime.Today - Model.ExpiryDate).Days) يوم
                            </div>
                        }
                        else if (Model.IsExpiringSoon)
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-clock"></i>
                                <strong>تنبيه:</strong> هذا الكارت سينتهي خلال @((Model.ExpiryDate - DateTime.Today).Days) يوم
                            </div>
                        }

                        <!-- Action Buttons -->
                        <hr>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="fas fa-save"></i> حفظ التغييرات
                            </button>
                            <a href="/VisitCards" class="btn btn-secondary">
                                <i class="fas fa-times"></i> إلغاء
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function() {
            // Calculate duration between dates
            function updateDuration() {
                const issueDate = new Date($('#issueDate').val());
                const expiryDate = new Date($('#expiryDate').val());

                if (issueDate && expiryDate) {
                    const diffTime = Math.abs(expiryDate - issueDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const diffMonths = Math.round(diffDays / 30);

                    $('#durationText').html(`<i class="fas fa-clock"></i> المدة: ${diffMonths} شهر (${diffDays} يوم)`);
                }
            }

            $('#issueDate, #expiryDate').on('change', updateDuration);
            updateDuration();

            // Update payment label
            $('#isPaidSwitch').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#paidLabel').text('مدفوع').removeClass('text-danger').addClass('text-success');
                } else {
                    $('#paidLabel').text('غير مدفوع').removeClass('text-success').addClass('text-danger');
                }
            });

            // Set initial label based on current state
            if ($('#isPaidSwitch').is(':checked')) {
                $('#paidLabel').addClass('text-success').removeClass('text-danger');
            } else {
                $('#paidLabel').addClass('text-danger').removeClass('text-success');
            }

            // Form validation
            $('#editCardForm').on('submit', function(e) {
                if (!confirm('هل أنت متأكد من حفظ التعديلات؟')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}