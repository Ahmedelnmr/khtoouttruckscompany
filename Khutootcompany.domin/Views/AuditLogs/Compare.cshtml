@{
    ViewData["Title"] = "مقارنة العمليات";
    var log1 = ViewBag.Log1 as Khutootcompany.Application.Interfaces.AuditLogDto;
    var log2 = ViewBag.Log2 as Khutootcompany.Application.Interfaces.AuditLogDto;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-exchange-alt"></i> مقارنة العمليات
        </h1>
        <div>
            <a href="/AuditLogs" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> رجوع للسجل
            </a>
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> طباعة
            </button>
        </div>
    </div>

    <!-- Comparison Summary -->
    <div class="row mb-4">
        <div class="col-md-5">
            <div class="card shadow border-primary h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> العملية الأولى
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong><i class="fas fa-hashtag text-primary"></i> المعرف:</strong>
                            <span class="float-end">#@log1.AuditLogId</span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-database text-info"></i> الكيان:</strong>
                            <span class="float-end">@log1.EntityName #@log1.EntityId</span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-tag text-success"></i> الإجراء:</strong>
                            <span class="badge bg-@(log1.Action == "Added" ? "success" : log1.Action == "Modified" ? "warning" : "danger") float-end">
                                @log1.Action
                            </span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-user text-primary"></i> المستخدم:</strong>
                            <span class="float-end">@log1.PerformedBy</span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-calendar text-warning"></i> التاريخ:</strong>
                            <span class="float-end">@log1.PerformedAt.ToString("dd/MM/yyyy HH:mm:ss")</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-2 d-flex align-items-center justify-content-center">
            <div class="text-center">
                <i class="fas fa-exchange-alt fa-5x text-primary"></i>
                <h5 class="mt-3 text-muted">VS</h5>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow border-success h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> العملية الثانية
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong><i class="fas fa-hashtag text-success"></i> المعرف:</strong>
                            <span class="float-end">#@log2.AuditLogId</span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-database text-info"></i> الكيان:</strong>
                            <span class="float-end">@log2.EntityName #@log2.EntityId</span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-tag text-success"></i> الإجراء:</strong>
                            <span class="badge bg-@(log2.Action == "Added" ? "success" : log2.Action == "Modified" ? "warning" : "danger") float-end">
                                @log2.Action
                            </span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-user text-primary"></i> المستخدم:</strong>
                            <span class="float-end">@log2.PerformedBy</span>
                        </li>
                        <li class="list-group-item">
                            <strong><i class="fas fa-calendar text-warning"></i> التاريخ:</strong>
                            <span class="float-end">@log2.PerformedAt.ToString("dd/MM/yyyy HH:mm:ss")</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Similarities & Differences -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle"></i> أوجه التشابه
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        @if (log1.EntityName == log2.EntityName)
                        {
                            <li class="list-group-item list-group-item-success">
                                <i class="fas fa-check"></i> نفس نوع الكيان: <strong>@log1.EntityName</strong>
                            </li>
                        }
                        @if (log1.EntityId == log2.EntityId)
                        {
                            <li class="list-group-item list-group-item-success">
                                <i class="fas fa-check"></i> نفس رقم الكيان: <strong>#@log1.EntityId</strong>
                            </li>
                        }
                        @if (log1.Action == log2.Action)
                        {
                            <li class="list-group-item list-group-item-success">
                                <i class="fas fa-check"></i> نفس نوع الإجراء: <strong>@log1.Action</strong>
                            </li>
                        }
                        @if (log1.PerformedBy == log2.PerformedBy)
                        {
                            <li class="list-group-item list-group-item-success">
                                <i class="fas fa-check"></i> نفس المستخدم: <strong>@log1.PerformedBy</strong>
                            </li>
                        }
                        @if (log1.PerformedAt.Date == log2.PerformedAt.Date)
                        {
                            <li class="list-group-item list-group-item-success">
                                <i class="fas fa-check"></i> نفس اليوم: <strong>@log1.PerformedAt.ToString("dd/MM/yyyy")</strong>
                            </li>
                        }
                    </ul>

                    @{
                        var similarities = 0;
                        if (log1.EntityName == log2.EntityName) similarities++;
                        if (log1.EntityId == log2.EntityId) similarities++;
                        if (log1.Action == log2.Action) similarities++;
                        if (log1.PerformedBy == log2.PerformedBy) similarities++;
                        if (log1.PerformedAt.Date == log2.PerformedAt.Date) similarities++;

                        if (similarities == 0)
                        {
                            <div class="alert alert-warning mt-3 mb-0">
                                <i class="fas fa-info-circle"></i> لا توجد أوجه تشابه واضحة بين العمليتين
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success mt-3 mb-0">
                                <i class="fas fa-check-circle"></i> <strong>@similarities</strong> أوجه تشابه من أصل 5
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-times-circle"></i> الاختلافات
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        @if (log1.EntityName != log2.EntityName)
                        {
                            <li class="list-group-item list-group-item-danger">
                                <i class="fas fa-times"></i> نوع الكيان: 
                                <strong>@log1.EntityName</strong> ≠ <strong>@log2.EntityName</strong>
                            </li>
                        }
                        @if (log1.EntityId != log2.EntityId)
                        {
                            <li class="list-group-item list-group-item-danger">
                                <i class="fas fa-times"></i> رقم الكيان: 
                                <strong>#@log1.EntityId</strong> ≠ <strong>#@log2.EntityId</strong>
                            </li>
                        }
                        @if (log1.Action != log2.Action)
                        {
                            <li class="list-group-item list-group-item-danger">
                                <i class="fas fa-times"></i> نوع الإجراء: 
                                <strong>@log1.Action</strong> ≠ <strong>@log2.Action</strong>
                            </li>
                        }
                        @if (log1.PerformedBy != log2.PerformedBy)
                        {
                            <li class="list-group-item list-group-item-danger">
                                <i class="fas fa-times"></i> المستخدم: 
                                <strong>@log1.PerformedBy</strong> ≠ <strong>@log2.PerformedBy</strong>
                            </li>
                        }
                        @{
                            var timeDiff = Math.Abs((log1.PerformedAt - log2.PerformedAt).TotalMinutes);
                        }
                        <li class="list-group-item list-group-item-warning">
                            <i class="fas fa-clock"></i> الفرق الزمني: 
                            <strong>
                                @if (timeDiff < 60)
                                {
                                    <text>@((int)timeDiff) دقيقة</text>
                                }
                                else if (timeDiff < 1440)
                                {
                                    <text>@((int)(timeDiff / 60)) ساعة</text>
                                }
                                else
                                {
                                    <text>@((int)(timeDiff / 1440)) يوم</text>
                                }
                            </strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Values Comparison -->
    <div class="card shadow">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-code"></i> مقارنة القيم
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Log 1 Old Values -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-primary">
                        <i class="fas fa-arrow-left"></i> العملية الأولى - القيم القديمة
                    </h6>
                    @if (!string.IsNullOrEmpty(log1.OldValues))
                    {
                        <pre class="bg-light p-3 rounded border border-primary" style="max-height: 300px; overflow-y: auto;"><code id="log1Old">@log1.OldValues</code></pre>
                    }
                    else
                    {
                        <div class="alert alert-secondary">لا توجد قيم قديمة</div>
                    }
                </div>

                <!-- Log 1 New Values -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-primary">
                        <i class="fas fa-arrow-right"></i> العملية الأولى - القيم الجديدة
                    </h6>
                    @if (!string.IsNullOrEmpty(log1.NewValues))
                    {
                        <pre class="bg-light p-3 rounded border border-primary" style="max-height: 300px; overflow-y: auto;"><code id="log1New">@log1.NewValues</code></pre>
                    }
                    else
                    {
                        <div class="alert alert-secondary">لا توجد قيم جديدة</div>
                    }
                </div>

                <!-- Log 2 Old Values -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-success">
                        <i class="fas fa-arrow-left"></i> العملية الثانية - القيم القديمة
                    </h6>
                    @if (!string.IsNullOrEmpty(log2.OldValues))
                    {
                        <pre class="bg-light p-3 rounded border border-success" style="max-height: 300px; overflow-y: auto;"><code id="log2Old">@log2.OldValues</code></pre>
                    }
                    else
                    {
                        <div class="alert alert-secondary">لا توجد قيم قديمة</div>
                    }
                </div>

                <!-- Log 2 New Values -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-success">
                        <i class="fas fa-arrow-right"></i> العملية الثانية - القيم الجديدة
                    </h6>
                    @if (!string.IsNullOrEmpty(log2.NewValues))
                    {
                        <pre class="bg-light p-3 rounded border border-success" style="max-height: 300px; overflow-y: auto;"><code id="log2New">@log2.NewValues</code></pre>
                    }
                    else
                    {
                        <div class="alert alert-secondary">لا توجد قيم جديدة</div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card shadow mt-4">
        <div class="card-body">
            <h6 class="mb-3"><i class="fas fa-tools"></i> إجراءات سريعة</h6>
            <div class="btn-group" role="group">
                <a href="/AuditLogs/Details/@log1.AuditLogId" class="btn btn-outline-primary">
                    <i class="fas fa-info-circle"></i> تفاصيل العملية الأولى
                </a>
                <a href="/AuditLogs/Details/@log2.AuditLogId" class="btn btn-outline-success">
                    <i class="fas fa-info-circle"></i> تفاصيل العملية الثانية
                </a>
                <a href="/AuditLogs/ByEntity?entityName=@log1.EntityName&entityId=@log1.EntityId" class="btn btn-outline-info">
                    <i class="fas fa-history"></i> سجل الكيان الأول
                </a>
                @if (log1.EntityName != log2.EntityName || log1.EntityId != log2.EntityId)
                {
                    <a href="/AuditLogs/ByEntity?entityName=@log2.EntityName&entityId=@log2.EntityId" class="btn btn-outline-warning">
                        <i class="fas fa-history"></i> سجل الكيان الثاني
                    </a>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function formatJson(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                try {
                    const json = JSON.parse(element.textContent);
                    element.textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    // Not JSON, leave as is
                }
            }
        }

        // Auto-format on load
        window.addEventListener('load', function() {
            formatJson('log1Old');
            formatJson('log1New');
            formatJson('log2Old');
            formatJson('log2New');
        });
    </script>

    <style>
        @@media print {
            .btn { display: none !important; }
            .card-header {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
}